<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .text-on-dark { color: #e5e7eb; }
    .muted-on-dark { color: #9ca3af; }
    .glass-dark {
        background: rgba(30, 30, 46, 0.5);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .neon-border {
        border-radius: 0.75rem;
        box-shadow: 0 0 5px rgba(236, 72, 153, 0.3), 0 0 10px rgba(236, 72, 153, 0.2);
    }
    .table-glass {
        background: rgba(30, 30, 46, 0.5);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .table-glass th {
        background: rgba(255, 255, 255, 0.05);
    }
    .table-glass tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 25;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }
    .sidebar-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }
    .sidebar-glass {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar-button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      color: #d1d5db;
      transition: background-color 0.2s, color 0.2s;
    }
    .sidebar-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }
    .sidebar-button i {
      width: 1.25rem;
      margin-right: 0.75rem;
      text-align: center;
    }
    
    /* Custom scrollbar styles */
    .scrollbar-thin {
      scrollbar-width: thin;
      scrollbar-color: rgba(156, 163, 175, 0.5) rgba(229, 231, 235, 0.2);
    }
    
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(229, 231, 235, 0.2);
      border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: rgba(156, 163, 175, 0.7);
    }
    
    /* Mobile-specific improvements */
    @media (max-width: 768px) {
      .sidebar-glass {
        width: 280px;
        transform: translateX(-100%);
      }
      .sidebar-glass.open {
        transform: translateX(0);
      }
      .main-content {
        padding: 1rem;
      }
      .glass-dark {
        margin: 0.5rem 0;
      }
      .grid {
        gap: 1rem;
      }
      .text-4xl {
        font-size: 2rem;
      }
      .text-2xl {
        font-size: 1.5rem;
      }
      .p-6 {
        padding: 1rem;
      }
      .px-6 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .py-4 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
      .table-glass {
        font-size: 0.875rem;
      }
      .table-glass th,
      .table-glass td {
        padding: 0.5rem;
      }
      #sidebar-toggle {
        display: block;
      }
    }
    
    @media (min-width: 769px) {
      #sidebar-toggle {
        display: none;
      }
      .sidebar-glass {
        transform: translateX(0);
      }
    }
  </style>
</head>
<body class="bg-[#2a104f] min-h-screen relative overflow-hidden">

  <div id="vanta-bg" class="fixed top-0 left-0 w-full h-full z-0"></div>
  <!-- Decorative floating elements -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-20 left-10 w-20 h-20 bg-white bg-opacity-10 rounded-full blur-xl"></div>
    <div class="absolute top-40 right-20 w-32 h-32 bg-white bg-opacity-5 rounded-full blur-2xl"></div>
    <div class="absolute bottom-20 left-1/4 w-24 h-24 bg-white bg-opacity-15 rounded-full blur-lg"></div>
    <div class="absolute bottom-40 right-1/3 w-16 h-16 bg-white bg-opacity-20 rounded-full blur-md"></div>
  </div>
<button id="sidebar-toggle" class="fixed top-4 left-4 z-50 md:hidden bg-pink-600 text-white p-2 rounded shadow">
  <i class="fas fa-bars"></i>
</button>

<div class="flex h-screen relative z-10">
  <!-- Sidebar Overlay -->
  <div id="sidebar-overlay" class="sidebar-overlay"></div>
  
  <aside id="sidebar" class="sidebar-glass sidebar-parallax w-64 h-screen fixed left-0 top-0 transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 z-30 text-white">
    <!-- Sidebar content here -->
    <div class="sidebar-header px-6 py-4 font-bold text-lg">
      <div class="flex items-center justify-between">
        <button id="sidebar-menu-toggle" class="p-2 rounded hover:bg-white/10" title="Toggle menu">
          <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5h14v2H3V5zm0 4h14v2H3V9zm0 4h14v2H3v-2z" clip-rule="evenodd"/></svg>
        </button>
        <span class="ml-4">Teacher</span>
      </div>
    </div>
    <nav class="sidebar-content px-2">
      <button class="sidebar-button" data-page="dashboard"><i class="fas fa-home"></i><span class="label">Dashboard</span></button>
      <button class="sidebar-button" data-page="search"><i class="fas fa-search"></i><span class="label">Search Students</span></button>
      <button class="sidebar-button" data-page="attendance"><i class="fas fa-chart-line"></i><span class="label">Attendance Overview</span></button>
      <button class="sidebar-button" data-page="view"><i class="fas fa-users"></i><span class="label">View Students</span></button>
      <button class="sidebar-button" data-page="courses"><i class="fas fa-book"></i><span class="label">Course List</span></button>
      <button class="sidebar-button" data-page="scholarship"><i class="fas fa-award"></i><span class="label">Scholarship Students</span></button>
      <button class="sidebar-button" data-page="day-scholar"><i class="fas fa-bus"></i><span class="label">Day Scholar</span></button>
      <button class="sidebar-button" data-page="hostel"><i class="fas fa-hotel"></i><span class="label">Hostel</span></button>
      <button class="sidebar-button" data-page="outside"><i class="fas fa-house-damage"></i><span class="label">Outside Staying</span></button>
      <button class="sidebar-button" data-page="passes"><i class="fas fa-ticket"></i><span class="label">Out Pass Approvals</span><span id="expired-pass-badge" class="hidden ml-2 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">0</span></button>
      <button class="sidebar-button" data-page="leave-approvals"><i class="fas fa-calendar-check"></i><span class="label">Leave Approvals</span><span id="leave-pending-badge" class="hidden ml-2 bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full animate-pulse">0</span></button>
      <button class="sidebar-button" data-page="change-password"><i class="fas fa-key"></i><span class="label">Change Password</span></button>
      <button class="sidebar-button mt-8 w-full flex items-center justify-start text-red-500" id="logout-btn">
        <i class="fas fa-sign-out-alt mr-2"></i>
        <span class="label">Logout</span>
      </button>
    </nav>
  </aside>
  <div id="main-wrapper" class="flex-1 flex flex-col overflow-hidden md:ml-10 transition-all duration-300">
    <main id="main-content" class="flex-1 p-6 overflow-y-auto"></main>
  </div>
</div>

  <!-- Student Details Modal -->
  <div id="student-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
    <div id="student-modal-content" class="glass-dark neon-border p-6 w-full max-w-[90vw] sm:max-w-3xl relative max-h-[85vh] overflow-y-auto scrollbar-thin">
      <button id="close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white">✕</button>
      <h3 class="text-lg font-bold text-on-dark mb-4">Student Details</h3>
      <div id="student-details" class="space-y-2 text-on-dark">Loading...</div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    VANTA.NET({
        el: "#vanta-bg",
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        minHeight: 200.00,
        minWidth: 200.00,
        scale: 1.00,
        scaleMobile: 1.00,
        color: 0xec4899,
        backgroundColor: 0x2a104f,
        points: 10.00,
        maxDistance: 25.00,
        spacing: 18.00
    });

    let allStudents = [];

    // Pass department and attendance data from Flask
    const teacherDepartment = {{ department|tojson|safe }} || 'All';
    const todayAbsent = {{ today_absent|tojson|safe }} || [];
    const lowAttendance = {{ low_attendance|tojson|safe }} || [];
    const departmentStudents = {{ department_students|tojson|safe }} || [];
    const hostellers = {{ hostellers|tojson|safe }} || [];
    const dayScholars = {{ day_scholars|tojson|safe }} || [];
    const outstayingStudents = {{ outstaying_students|tojson|safe }} || [];
    const itCount = {{ it_count|tojson|safe }} || 0;
    const aimlCount = {{ aiml_count|tojson|safe }} || 0;
    // Initialize the working dataset with department-specific students so View table renders rows
    allStudents = Array.isArray(departmentStudents) ? departmentStudents : [];
    
    // Build stats cards dynamically per department
    const statsCards = [];
    if (teacherDepartment === 'AI & ML') {
      statsCards.push(`
          <div class="bg-white/5 rounded p-3">
            <div class="text-3xl font-bold text-pink-400">${aimlCount}</div>
            <div class="text-sm text-gray-400">AI & ML Students</div>
          </div>`);
    }
    if (teacherDepartment === 'IT') {
      statsCards.push(`
          <div class="bg-white/5 rounded p-3">
            <div class="text-3xl font-bold text-indigo-400">${itCount}</div>
            <div class="text-sm text-gray-400">IT Students</div>
          </div>`);
    }
    statsCards.push(`
          <div class="bg-white/5 rounded p-3">
            <div class="text-3xl font-bold text-green-400">${hostellers.length}</div>
            <div class="text-sm text-gray-400">Hostellers</div>
          </div>`);
    statsCards.push(`
          <div class="bg-white/5 rounded p-3">
            <div class="text-3xl font-bold text-yellow-400">${dayScholars.length}</div>
            <div class="text-sm text-gray-400">Day Scholars</div>
          </div>`);
    statsCards.push(`
          <div class="bg-white/5 rounded p-3">
            <div class="text-3xl font-bold text-purple-400">${outstayingStudents.length}</div>
            <div class="text-sm text-gray-400">Outside Staying</div>
          </div>`);

    // Content Templates
    const welcomeContent = `
    <div class="space-y-6">
      <div class="glass-dark neon-border p-6 mb-4">
        <h1 class="text-2xl font-bold text-white mb-2">${teacherDepartment} Department - Teacher Dashboard</h1>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
          ${statsCards.join('')}
        </div>
      </div>
      
      <!-- Expired Pass Alert for Teachers -->
      <div id="teacher-expired-alert" class="hidden glass-dark neon-border p-4 border-l-4 border-red-500">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-3 mt-1"></i>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-red-400 mb-2">⚠️ STUDENTS WITH EXPIRED OUT PASSES</h3>
            <div id="teacher-expired-details" class="text-white/90 text-sm space-y-1"></div>
            <button onclick="navigate('passes')" class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
              <i class="fas fa-eye mr-2"></i>View All Expired Passes
            </button>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass-dark neon-border p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-on-dark">Today's Absent Students</h2>
          <span id="teacher-absent-count" class="text-sm text-red-400 font-semibold">${todayAbsent.length} absent</span>
        </div>
        <div id="teacher-absent-list" class="space-y-2 text-on-dark max-h-80 overflow-y-auto scrollbar-thin">
          ${todayAbsent.length > 0 ? 
            todayAbsent.map(s => `
              <div class="p-2 bg-white/5 rounded hover:bg-white/10 transition-colors">
                <span class="font-medium">${s.rollno}</span> - 
                <span class="text-gray-300">${s.name || 'Name not available'}</span>
              </div>
            `).join('') : 
            '<div class="muted-on-dark">No absent students today</div>'
          }
        </div>
        <div class="mt-3 text-xs muted-on-dark">Updated from Google Sheets attendance data</div>
      </div>
      
      <div class="glass-dark neon-border p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-on-dark">Low Attendance Alert (&lt; 75%)</h2>
          <span id="low-attn-count" class="text-sm text-yellow-400 font-semibold">${lowAttendance.length} students</span>
        </div>
        <div id="low-attendance-list" class="space-y-2 text-on-dark max-h-80 overflow-y-auto scrollbar-thin">
          ${lowAttendance.length > 0 ? 
            lowAttendance.map(s => `
              <div class="p-3 bg-white/5 rounded hover:bg-white/10 transition-colors border-l-4 border-yellow-500">
                <div class="flex justify-between items-center">
                  <div>
                    <span class="font-medium">${s.rollno}</span> - 
                    <span class="text-gray-300">${s.name || 'Name not available'}</span>
                  </div>
                  <span class="text-sm font-bold ${s.attendance < 50 ? 'text-red-500' : 'text-yellow-500'}">
                    ${s.attendance}%
                  </span>
                </div>
              </div>
            `).join('') : 
            '<div class="muted-on-dark">No students with low attendance</div>'
          }
        </div>
      </div>
    </div>
    `;

    const searchContent = `
    <div class="glass-dark neon-border p-6">
      <h2 class="text-lg font-bold text-on-dark mb-4">Search Students</h2>
      <input id="search-bar" type="text" placeholder="Search by name or roll no..." class="w-full p-3 rounded mb-4 bg-white/10 border border-white/20 text-on-dark placeholder:muted-on-dark focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
      <div class="overflow-x-auto">
        <table class="min-w-full table-glass">
          <thead>
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Roll No</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Action</th>
            </tr>
          </thead>
          <tbody id="search-results"></tbody>
        </table>
      </div>
    </div>
    `;

    const teacherFullStudentTableContent = `
    <div class="container mx-auto">
      <h2 class="text-2xl font-semibold text-on-dark mb-4">All Students (Full View)</h2>
      <div class="glass-dark neon-border overflow-hidden">
        <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
          <table class="min-w-full table-glass">
            <thead class="sticky top-0 z-10">
              <tr id="teacher-student-table-header"></tr>
            </thead>
            <tbody id="teacher-student-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
    `;

    const attendanceContent = `
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-on-dark">Students Attendance Overview</h2>
        <div id="att-loading" class="text-sm muted-on-dark">Loading attendance...</div>
      </div>
      <div id="att-error" class="text-sm text-red-500 mb-3 hidden"></div>
      <div class="glass-dark neon-border overflow-hidden">
        <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
          <table class="min-w-full table-glass" id="att-table">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Reg No</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Roll No</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Present Days</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Total Days</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Attendance %</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
            <tbody id="att-tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="mt-2 text-xs muted-on-dark">Fetched from /teacher/all_students_attendance_averages</div>
      </div>
    `;

    const changePasswordContent = `
    <div class="glass-dark neon-border p-6 max-w-md mx-auto">
      <h2 class="text-lg font-bold text-on-dark mb-4">Change My Password</h2>
      <label class="block text-sm font-medium text-on-dark">New Password</label>
      <input type="password" id="new-password" class="w-full p-2 rounded mt-1 bg-white/10 border border-white/20 text-on-dark placeholder:muted-on-dark focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
      <button id="change-password-btn" class="mt-4 w-full bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700 transition-colors">Change Password</button>
      <p id="password-message" class="text-sm mt-2"></p>
    </div>
    `;

    const coursesContent = `
<div class="container mx-auto">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-semibold text-on-dark flex items-center">
      <i class="fas fa-book-open text-purple-400 mr-3"></i>
      Course List
    </h2>
    <div id="courses-loading" class="text-sm text-purple-300">
      <i class="fas fa-spinner fa-spin mr-2"></i>Loading courses...
    </div>
  </div>
  <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  <div id="courses-empty" class="glass-dark neon-border p-12 text-center hidden">
    <i class="fas fa-book text-6xl text-white/20 mb-4"></i>
    <p class="text-white/60 text-lg">No courses found.</p>
  </div>
</div>
`;

    const passesContent = `
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-on-dark">Out Pass Approvals (Advisor)</h2>
        <button id="tch-refresh-passes" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">Refresh</button>
      </div>
      <div id="tch-passes-error" class="text-sm text-red-400 mb-2 hidden"></div>
      <div class="glass-dark neon-border overflow-hidden">
        <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
          <table class="min-w-full table-glass">
            <thead>
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Roll</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Dept</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">From</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">To</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Details</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="tch-passes-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>`;

    const leaveApprovalsContent = `
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-on-dark flex items-center">
          <i class="fas fa-calendar-check text-orange-400 mr-3"></i>
          Leave Request Approvals
        </h2>
        <button id="refresh-leave-approvals" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-all">
          <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
      </div>
      
      <div class="glass-dark neon-border overflow-hidden">
        <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
          <table class="min-w-full table-glass">
            <thead class="sticky top-0 z-10">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Student Name</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Roll No</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Leave Type</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">From Date</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">To Date</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Reason</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="leave-approvals-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>`;

    const itStudentsContent = `
      <div class="container mx-auto">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold text-on-dark">IT Students Details</h2>
          <div class="flex items-center gap-2">
            <span class="text-sm text-indigo-400 font-semibold">${itCount} IT Students</span>
          </div>
        </div>
        <div class="glass-dark neon-border overflow-hidden">
          <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
            <table class="min-w-full table-glass">
              <thead class="sticky top-0 z-10">
                <tr>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Reg No</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Name</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Roll No</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Class/Sem</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Scholarship</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Hostel/Day</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Bus/Room No</th>
                </tr>
              </thead>
              <tbody id="it-students-body"></tbody>
            </table>
          </div>
        </div>
      </div>`;

    const aimlStudentsContent = `
      <div class="container mx-auto">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold text-on-dark">AI & ML Students Details</h2>
          <div class="flex items-center gap-2">
            <span class="text-sm text-pink-400 font-semibold">${aimlCount} AI & ML Students</span>
          </div>
        </div>
        <div class="glass-dark neon-border overflow-hidden">
          <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
            <table class="min-w-full table-glass">
              <thead class="sticky top-0 z-10">
                <tr>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Reg No</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Name</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Roll No</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Class/Sem</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Scholarship</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Hostel/Day</th>
                  <th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">Bus/Room No</th>
                </tr>
              </thead>
              <tbody id="aiml-students-body"></tbody>
            </table>
          </div>
        </div>
      </div>`;

    const scholarshipContent = `
<div class="container mx-auto">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-2xl font-semibold text-on-dark">Scholarship Students</h2>
  </div>
  <div class="flex flex-wrap gap-2 mb-4">
    <button class="px-3 py-1 text-xs rounded bg-pink-600 text-white" data-sch="pmss">PMSS</button>
    <button class="px-3 py-1 text-xs rounded bg-white/10 text-on-dark" data-sch="mbc_bc">MBC/BC</button>
    <button class="px-3 py-1 text-xs rounded bg-white/10 text-on-dark" data-sch="tps">TPS</button>
    <button class="px-3 py-1 text-xs rounded bg-white/10 text-on-dark" data-sch="seven_five">7.5</button>
    <button class="px-3 py-1 text-xs rounded bg-white/10 text-on-dark" data-sch="pps">PPS</button>
  </div>
  <div class="glass-dark neon-border overflow-hidden">
    <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
      <table class="min-w-full table-glass">
        <thead class="sticky top-0 z-10"><tr id="flt-hdr"></tr></thead>
        <tbody id="flt-body"></tbody>
      </table>
    </div>
  </div>
</div>`;

    const filteredListContent = (title) => `
<div class="container mx-auto">
  <h2 class="text-2xl font-semibold text-on-dark mb-4">${title}</h2>
  <div class="glass-dark neon-border overflow-hidden">
    <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
      <table class="min-w-full table-glass">
        <thead class="sticky top-0 z-10"><tr id="flt-hdr"></tr></thead>
        <tbody id="flt-body"></tbody>
      </table>
    </div>
  </div>
</div>`;


    async function loadITStudents(){
      const tbody = document.getElementById('it-students-body');
      if (!tbody) return;
      
      try {
        const res = await fetch('/students?dept=IT');
        const data = await res.json();
        const itStudents = Array.isArray(data) ? data : [];
        
        tbody.innerHTML = itStudents.map(s => {
          const hostelDay = s.day_scholar_or_hosteller || '';
          const busRoomNo = hostelDay.toLowerCase().includes('day') ? (s.bus_no || '') : (s.hosteller_room_no || '');
          const scholarship = s.scholarship || s.remarks || '';
          
          return `
            <tr class="border-b border-white/5 hover:bg-white/5">
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${s.reg_no || ''}">${s.reg_no || ''}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${s.name || ''}">${s.name || ''}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${s.rollno || ''}">${s.rollno || ''}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${s.current_semester || ''}">${s.current_semester || ''}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${scholarship}">${scholarship}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${hostelDay}">${hostelDay}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${busRoomNo}">${busRoomNo}</td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-3 py-2 text-center text-red-400">Error loading IT students</td></tr>';
      }
    }

    async function loadAIMLStudents(){
      const tbody = document.getElementById('aiml-students-body');
      if (!tbody) return;
      
      try {
        const res = await fetch('/students?dept=AI & ML');
        const data = await res.json();
        const aimlStudents = Array.isArray(data) ? data : [];
        
        tbody.innerHTML = aimlStudents.map(s => {
          const hostelDay = s.day_scholar_or_hosteller || '';
          const busRoomNo = hostelDay.toLowerCase().includes('day') ? (s.bus_no || '') : (s.hosteller_room_no || '');
          const scholarship = s.scholarship || s.remarks || '';
          
          return `
            <tr class="border-b border-white/5 hover:bg-white/5">
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${s.reg_no || ''}">${s.reg_no || ''}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${s.name || ''}">${s.name || ''}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${s.rollno || ''}">${s.rollno || ''}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${s.current_semester || ''}">${s.current_semester || ''}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${scholarship}">${scholarship}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${hostelDay}">${hostelDay}</td>
              <td class="px-3 py-2 text-[12px] truncate align-top" title="${busRoomNo}">${busRoomNo}</td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-3 py-2 text-center text-red-400">Error loading AI & ML students</td></tr>';
      }
    }

    function renderFiltered(list, cols){
      const hdr = document.getElementById('flt-hdr'); const body = document.getElementById('flt-body'); if (!hdr||!body) return;
      hdr.innerHTML = cols.map(c=>`<th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">${c.label}</th>`).join('');
      body.innerHTML = list.map(s=>`<tr class="border-b border-white/5 hover:bg-white/5">${cols.map(c=>`<td class="px-3 py-2 text-[12px] truncate align-top" title="${s[c.key]||''}\">${s[c.key]||''}</td>`).join('')}</tr>`).join('');
    }

    function renderContent(content) {
      document.getElementById('main-content').innerHTML = content;
    }

    // Track which badges have been viewed
    let teacherPassBadgeViewed = false;
    let teacherLeaveBadgeViewed = false;

    function handleNavigation(page) {
      // Clear notification badges when viewing the respective pages
      if (page === 'passes') {
        const expiredBadge = document.getElementById('expired-pass-badge');
        if (expiredBadge) {
          expiredBadge.classList.add('hidden');
          teacherPassBadgeViewed = true;
        }
      }
      if (page === 'leave-approvals') {
        const leaveBadge = document.getElementById('leave-pending-badge');
        if (leaveBadge) {
          leaveBadge.classList.add('hidden');
          teacherLeaveBadgeViewed = true;
        }
      }
      
      switch (page) {
        case "search": renderContent(searchContent); initSearch(); break;
        case "attendance": renderContent(attendanceContent); setTimeout(loadTeachersAttendance, 0); break;
        case "view": 
          renderContent(teacherFullStudentTableContent);
          setTimeout(() => { renderTeacherFullStudentTable(allStudents); }, 0);
          break;
        case "it-students": renderContent(itStudentsContent); setTimeout(loadITStudents, 0); break;
        case "aiml-students": renderContent(aimlStudentsContent); setTimeout(loadAIMLStudents, 0); break;
        case "scholarship":
          renderContent(scholarshipContent);
          setTimeout(async ()=>{
            const renderCategory = (cat)=>{
              const cols = [
                {key:'reg_no',label:'Reg No'},
                {key:'name',label:'Name'},
                {key:'rollno',label:'Roll No'},
                {key:'category',label:'Scholarship'}
              ];
              const list = (allStudents||[]).filter(s=>{
                const sch = String(s.scholarship||'').toLowerCase();
                const pmss = String(s.pmss||'').toLowerCase();
                const remarks = String(s.remarks||'').toLowerCase();
                if (cat==='pmss') return pmss === 'yes' || sch.includes('pmss') || remarks.includes('pmss');
                if (cat==='mbc_bc') return sch.includes('mbc') || sch.includes('bc') || remarks.includes('mbc') || remarks.includes('bc');
                if (cat==='tps') return sch.includes('tps') || remarks.includes('tps');
                if (cat==='seven_five') return sch.includes('7.5') || sch.includes('7,5') || remarks.includes('7.5');
                if (cat==='pps') return sch.includes('pps') || remarks.includes('pps');
                return false;
              }).map(({reg_no, name, rollno, scholarship, pmss})=>({
                reg_no, name, rollno,
                category: (cat==='pmss' ? 'PMSS' : (scholarship||'').toString()),
              }));
              renderFiltered(list, cols);
            };
            document.querySelectorAll('[data-sch]').forEach(b=>{
              b.addEventListener('click', (e)=>{
                document.querySelectorAll('[data-sch]').forEach(x=>{ x.classList.remove('bg-pink-600','text-white'); x.classList.add('bg-white/10','text-on-dark'); });
                e.currentTarget.classList.add('bg-pink-600','text-white');
                e.currentTarget.classList.remove('bg-white/10','text-on-dark');
                renderCategory(e.currentTarget.getAttribute('data-sch'));
              });
            });
            renderCategory('pmss');
          }, 0);
          break;
        case "day-scholar":
          renderContent(filteredListContent('Day Scholar Students'));
          setTimeout(async ()=>{
            const list = allStudents.filter(s => (s.day_scholar_or_hosteller||'').toLowerCase().includes('day'))
              .map(({reg_no, name, rollno, bus_no}) => ({reg_no, name, rollno, bus_no}));
            const cols = [
              {key:'reg_no',label:'Reg No'},
              {key:'name',label:'Name'},
              {key:'rollno',label:'Roll No'},
              {key:'bus_no',label:'Bus No'}
            ];
            renderFiltered(list, cols);
          }, 0);
          break;
        case "hostel":
          renderContent(filteredListContent('Hostel Students'));
          setTimeout(async ()=>{
            const list = allStudents.filter(s => (s.day_scholar_or_hosteller||'').toLowerCase().includes('hostel'))
              .map(({reg_no, name, rollno, hosteller_room_no}) => ({reg_no, name, rollno, hosteller_room_no}));
            const cols = [
              {key:'reg_no',label:'Reg No'},
              {key:'name',label:'Name'},
              {key:'rollno',label:'Roll No'},
              {key:'hosteller_room_no',label:'Room No'}
            ];
            renderFiltered(list, cols);
          }, 0);
          break;
        case "outside":
          renderContent(filteredListContent('Outside Staying Students'));
          setTimeout(async ()=>{
            const list = allStudents.filter(s =>
              s.outside_staying_address &&
              s.outside_staying_address.trim().toLowerCase() !== 'no' &&
              s.outside_staying_address.trim() !== ''
            ).map(({reg_no, name, rollno, outside_staying_address}) => ({reg_no, name, rollno, outside_staying_address}));
            const cols = [
              {key:'reg_no',label:'Reg No'},
              {key:'name',label:'Name'},
              {key:'rollno',label:'Roll No'},
              {key:'outside_staying_address',label:'Outside Staying Address'}
            ];
            renderFiltered(list, cols);
          }, 0);
          break;
        case "change-password": renderContent(changePasswordContent); document.getElementById('change-password-btn').onclick = changePassword; break;
        case "courses": renderContent(coursesContent); setTimeout(loadCourses, 0); break;
        case "passes": renderContent(passesContent); setTimeout(initTeacherPasses, 0); break;
        case "leave-approvals": renderContent(leaveApprovalsContent); setTimeout(loadLeaveApprovals, 0); break;
        case "dashboard":
        default:
          renderContent(welcomeContent);
          setTimeout(loadTeacherDailyAbsentStudents, 0);
          setTimeout(loadLowAttendanceAnnouncements, 200);
          setTimeout(checkExpiredPassesForTeacher, 300);
          break;
      }
    }

    // Sidebar Toggles & Navigation
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    const overlay = document.getElementById('sidebar-overlay');
    const menuToggle = document.getElementById('sidebar-menu-toggle');

    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        });
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        });
    }
    
    if (menuToggle && sidebar) {
    menuToggle.addEventListener('click', ()=>{
      const isCollapsed = sidebar.classList.contains('menu-collapsed');
      if (isCollapsed) {
        sidebar.classList.remove('menu-collapsed');
      } else {
        sidebar.classList.add('menu-collapsed');
      }
    });
  }

    document.querySelectorAll('.sidebar-button[data-page]').forEach(btn => {
        btn.addEventListener('click', function() {
            const page = this.getAttribute('data-page');
            handleNavigation(page);
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.remove('active');
            }
        });
    });

    document.getElementById('logout-btn').addEventListener('click', () => window.location.href = '/logout');

    // Modal Logic
    const studentModal = document.getElementById('student-modal');
    document.getElementById('close-modal').onclick = () => studentModal.classList.add('hidden');
    studentModal.onclick = function(e) { if (e.target === this) this.classList.add('hidden'); };

    // Data Loading
    async function loadStudents() {
      try {
        const res = await fetch('/students');
        allStudents = await res.json();
      } catch (e) { console.error('Error loading students', e); }
    }

    async function loadTeacherDailyAbsentStudents() {
      const listEl = document.getElementById('teacher-absent-list');
      const countEl = document.getElementById('teacher-absent-count');
      if (!listEl) return;
      try {
        const res = await fetch('/teacher/daily_absent_students', { headers: { 'Accept': 'application/json' } });
        const data = await res.json();
        const absentStudents = data?.success ? data.absent_students : [];
        
        if (countEl) countEl.textContent = `${absentStudents.length} absent today`;
        
        if (absentStudents.length === 0) {
          listEl.innerHTML = '<div class="text-green-400 font-semibold">🎉 All students present today!</div>';
          return;
        }
        
        listEl.innerHTML = absentStudents.map(s => `
          <div class="flex justify-between items-center p-2 bg-white/5 rounded">
            <div>
              <span class="font-semibold">${s.name}</span>
              <span class="text-xs muted-on-dark ml-2">(${s.rollno})</span>
            </div>
            <span class="text-xs ${s.status === 'No record' ? 'text-yellow-400' : 'text-red-400'}">${s.status}</span>
          </div>`).join('');
      } catch (e) {
        listEl.innerHTML = '<div class="text-red-400">Error loading absent students.</div>';
      }
    }

    async function loadLowAttendanceAnnouncements() {
      const listEl = document.getElementById('announcements-list');
      const countEl = document.getElementById('low-attn-count');
      if (!listEl) return;
      try {
        const res = await fetch('/teacher/all_students_attendance_averages');
        const data = await res.json();
        const students = data?.success ? data.students : [];
        const low = students.filter(s => (s.attendance_average || 0) < 75);
        
        if (countEl) countEl.textContent = `${low.length} below 75%`;
        if (low.length === 0) {
          listEl.innerHTML = '<li class="muted-on-dark">No students below 75% attendance 🎉</li>';
          return;
        }
        listEl.innerHTML = low.slice(0, 15).map(s => `
          <li><span class="font-semibold">${s.name}</span> (Roll: ${s.rollno}) — <span class="text-red-400 font-semibold">${Number(s.attendance_average || 0).toFixed(2)}%</span></li>
        `).join('');
      } catch (e) {
        listEl.innerHTML = '<li class="text-red-400">Error loading announcements.</li>';
      }
    }

    async function loadTeachersAttendance() {
      const loadingEl = document.getElementById('att-loading');
      const errorEl = document.getElementById('att-error');
      const tbodyEl = document.getElementById('att-tbody');
      if (tbodyEl) tbodyEl.innerHTML = '';
      if (errorEl) errorEl.classList.add('hidden');
      try {
        const response = await fetch('/teacher/all_students_attendance_averages');
        const data = await response.json();
        const students = data?.success ? data.students : [];

        tbodyEl.innerHTML = students.map(student => {
          const percentage = Number(student.attendance_average || 0);
          let colorClass = 'text-red-400', bgColorClass = 'bg-red-900/20', statusText = 'Poor';
          if (percentage >= 90) { colorClass = 'text-green-400'; bgColorClass = 'bg-green-900/20'; statusText = 'Excellent'; }
          else if (percentage >= 75) { colorClass = 'text-blue-400'; bgColorClass = 'bg-blue-900/20'; statusText = 'Good'; }
          else if (percentage >= 60) { colorClass = 'text-yellow-400'; bgColorClass = 'bg-yellow-900/20'; statusText = 'Fair'; }
          return `
            <tr class="border-b border-white/10">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-on-dark">${student.reg_no || '-'}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm muted-on-dark">${student.name}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm muted-on-dark">${student.rollno}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm muted-on-dark">${student.present_days}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm muted-on-dark">${student.total_days}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${colorClass}">${percentage.toFixed(2)}%</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bgColorClass} ${colorClass}">${statusText}</span>
              </td>
            </tr>`;
        }).join('');
      } catch (err) {
        if (errorEl) { errorEl.textContent = 'Error loading attendance.'; errorEl.classList.remove('hidden'); }
      } finally {
        if (loadingEl) loadingEl.classList.add('hidden');
      }
    }

    async function loadCourses(){
      const grid = document.getElementById('courses-grid');
      const loading = document.getElementById('courses-loading');
      const empty = document.getElementById('courses-empty');
      if (!grid) return;
      try{
        const res = await fetch('/courses');
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0){
          if (empty) empty.classList.remove('hidden');
          grid.innerHTML = '';
          return;
        }
        
        // Course card icons based on course name
        const getIcon = (courseName) => {
          const name = (courseName || '').toLowerCase();
          if (name.includes('python') || name.includes('programming')) return 'fa-code';
          if (name.includes('data') || name.includes('database')) return 'fa-database';
          if (name.includes('web') || name.includes('html')) return 'fa-globe';
          if (name.includes('machine') || name.includes('ai')) return 'fa-robot';
          if (name.includes('network')) return 'fa-network-wired';
          if (name.includes('security') || name.includes('cyber')) return 'fa-shield-alt';
          if (name.includes('cloud')) return 'fa-cloud';
          if (name.includes('mobile') || name.includes('android')) return 'fa-mobile-alt';
          return 'fa-book';
        };
        
        // Generate gradient colors
        const gradients = [
          'from-purple-600 to-pink-600',
          'from-blue-600 to-cyan-600',
          'from-green-600 to-teal-600',
          'from-orange-600 to-red-600',
          'from-indigo-600 to-purple-600',
          'from-pink-600 to-rose-600'
        ];
        
        grid.innerHTML = data.map((c, index) => {
          const gradient = gradients[index % gradients.length];
          const icon = getIcon(c.course_name);
          return `
            <div class="glass-dark neon-border rounded-lg overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
              <!-- Course Header with Gradient -->
              <div class="bg-gradient-to-r ${gradient} p-4 relative overflow-hidden">
                <div class="absolute top-0 right-0 opacity-10">
                  <i class="fas ${icon} text-8xl"></i>
                </div>
                <div class="relative z-10">
                  <i class="fas ${icon} text-3xl text-white mb-2"></i>
                  <h3 class="text-lg font-bold text-white line-clamp-2">${c.course_name || c.course_code}</h3>
                </div>
              </div>
              
              <!-- Course Body -->
              <div class="p-4">
                <div class="flex items-center mb-3">
                  <i class="fas fa-hashtag text-purple-400 mr-2"></i>
                  <span class="text-sm text-white/70 font-mono">${c.course_code || 'N/A'}</span>
                </div>
                
                <!-- Action Button -->
                <a href="${c.drive_link}" target="_blank" rel="noopener"
                   class="block w-full bg-gradient-to-r ${gradient} hover:opacity-90 text-white text-center py-2 px-4 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                  <i class="fas fa-external-link-alt mr-2"></i>
                  Open Course Materials
                </a>
              </div>
            </div>
          `;
        }).join('');
      } catch (e){
        grid.innerHTML = `
          <div class="col-span-full glass-dark neon-border p-6 text-center">
            <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-3"></i>
            <p class="text-red-400">Error loading courses.</p>
          </div>
        `;
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function renderTeacherFullStudentTable(data) {
      const columns = [
        { key: 'id', label: 'ID' }, { key: 'reg_no', label: 'Reg No' }, { key: 'rollno', label: 'Roll No' },
        { key: 'name', label: 'Name' }, { key: 'dob', label: 'DOB' }, { key: 'gender', label: 'Gender' },
        { key: 'aadhar', label: 'Aadhar' }, { key: 'student_mobile', label: 'Student Mobile' },
        { key: 'blood_group', label: 'Blood Group' }, { key: 'parent_name', label: 'Parent Name' },
        { key: 'parent_mobile', label: 'Parent Mobile' }, { key: 'address', label: 'Address' },
        { key: 'nationality', label: 'Nationality' }, { key: 'religion', label: 'Religion' },
        { key: 'community', label: 'Community' }, { key: 'caste', label: 'Caste' },
        { key: 'day_scholar_or_hosteller', label: 'Day Scholar/Hosteller' }, { key: 'current_semester', label: 'Class/Semester' },
        { key: 'seat_type', label: 'Seat Type' }, { key: 'quota_type', label: 'Quota Type' }, { key: 'email', label: 'Email' },
        { key: 'pmss', label: 'PMSS' }, { key: 'scholarship', label: 'Scholarship' }, { key: 'bus_no', label: 'Bus No' },
        { key: 'outside_staying_address', label: 'Outstaying Address' }, { key: 'hosteller_room_no', label: 'Room No' },
        { key: 'owner_ph_no', label: "Owner's Phone" }, { key: '__actions', label: 'Actions' }
      ];
      const headerRow = document.getElementById('teacher-student-table-header');
      if (headerRow) {
        headerRow.innerHTML = columns.map(col => `<th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">${col.label}</th>`).join('');
      }
      const body = document.getElementById('teacher-student-table-body');
      if (!body) return;
      body.innerHTML = data.map(s => `
        <tr class="border-b border-white/5 hover:bg-white/5">
          ${columns.map(col => {
            if (col.key === 'scholarship') {
              return `<td class="px-3 py-2 text-[12px] truncate align-top" title="${s.scholarship || ''}">${s.scholarship || '-'}</td>`;
            } else if (col.key === '__actions') {
              const r = (s.rollno || '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
              return `<td class="px-3 py-2 text-[12px] truncate align-top">
                        <button class="px-2 py-1 bg-purple-600 text-white rounded text-xs" onclick="openGiveOP('${r}')">Give Out Pass</button>
                      </td>`;
            } else {
              return `<td class="px-3 py-2 text-[12px] truncate align-top" title="${s[col.key] || ''}">${s[col.key] || ''}</td>`;
            }
          }).join('')}
        </tr>
      `).join('');
    }

    // Slide-over panel to create Out Pass for a student (teacher/advisor)
    window.openGiveOP = function(rollno){
      const student = (allStudents||[]).find(x => String(x.rollno||'') === String(rollno||''));
      const name = student?.name || '';
      const dept = student?.current_semester || '';
      const rootId = 'op-slide-root';
      if (document.getElementById(rootId)) document.getElementById(rootId).remove();
      const html = `
        <div id="${rootId}" class="fixed inset-0 z-50">
          <div class="absolute inset-0 bg-black/50" onclick="document.getElementById('${rootId}').remove()"></div>
          <div class="absolute top-0 right-0 h-full w-full max-w-md bg-[#1f2033] text-white shadow-2xl overflow-y-auto">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
              <h3 class="text-lg font-semibold">Give Out Pass</h3>
              <button class="text-white/70 hover:text-white" onclick="document.getElementById('${rootId}').remove()">✕</button>
            </div>
            <div class="p-4 space-y-3">
              <div class="text-sm text-white/80">Name: <span class="font-semibold">${name}</span></div>
              <div class="text-sm text-white/80">Roll No: <span class="font-semibold">${rollno}</span></div>
              <div class="text-sm text-white/80">Department: <span class="font-semibold">${dept}</span></div>
              <div>
                <label class="text-xs text-white/70">Type</label>
                <select id="tch-op-type" class="w-full p-2 rounded mt-1 bg-white/10 border border-white/20 text-white">
                  <option value="out_pass">Out Pass</option>
                  <option value="od_pass">OD Pass</option>
                  <option value="emergency">Emergency</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-white/70">Reason</label>
                <input id="tch-op-reason" class="w-full p-2 rounded mt-1 bg-white/10 border border-white/20 text-white" placeholder="Reason" />
              </div>
              <div id="tch-op-fromto" class="bg-gradient-to-br from-purple-900/30 to-blue-900/30 p-4 rounded-lg border border-purple-500/30">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-sm font-semibold text-white flex items-center">
                    <i class="fas fa-clock text-purple-400 mr-2"></i>
                    Pass Duration
                  </h4>
                  <span id="duration-display" class="text-xs text-purple-300"></span>
                </div>
                
                <!-- From DateTime -->
                <div class="mb-3">
                  <label class="text-xs font-medium text-purple-200 mb-2 flex items-center">
                    <i class="fas fa-play-circle text-green-400 mr-2"></i>
                    Start Time
                  </label>
                  <div class="relative">
                    <input id="tch-op-from" type="datetime-local" 
                      class="w-full p-3 pl-10 rounded-lg bg-white/5 border-2 border-purple-500/50 text-white text-sm
                             focus:border-purple-400 focus:ring-2 focus:ring-purple-500/50 focus:bg-white/10
                             transition-all duration-200 hover:border-purple-400/70" />
                    <i class="fas fa-calendar-day absolute left-3 top-1/2 transform -translate-y-1/2 text-purple-400"></i>
                  </div>
                </div>
                
                <!-- To DateTime -->
                <div class="mb-3">
                  <label class="text-xs font-medium text-purple-200 mb-2 flex items-center">
                    <i class="fas fa-stop-circle text-red-400 mr-2"></i>
                    End Time
                  </label>
                  <div class="relative">
                    <input id="tch-op-to" type="datetime-local" 
                      class="w-full p-3 pl-10 rounded-lg bg-white/5 border-2 border-purple-500/50 text-white text-sm
                             focus:border-purple-400 focus:ring-2 focus:ring-purple-500/50 focus:bg-white/10
                             transition-all duration-200 hover:border-purple-400/70" />
                    <i class="fas fa-calendar-check absolute left-3 top-1/2 transform -translate-y-1/2 text-purple-400"></i>
                  </div>
                </div>
                
                <!-- Quick Duration Presets -->
                <div class="border-t border-purple-500/30 pt-3">
                  <label class="text-xs font-medium text-purple-200 mb-2 block">Quick Duration Presets:</label>
                  <div class="grid grid-cols-3 gap-2">
                    <button type="button" onclick="setQuickTime('2h')" 
                      class="px-3 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 
                             text-white rounded-lg text-xs font-medium transition-all duration-200 
                             transform hover:scale-105 active:scale-95 shadow-lg">
                      <i class="fas fa-clock mr-1"></i>2 Hours
                    </button>
                    <button type="button" onclick="setQuickTime('4h')" 
                      class="px-3 py-2 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 
                             text-white rounded-lg text-xs font-medium transition-all duration-200 
                             transform hover:scale-105 active:scale-95 shadow-lg">
                      <i class="fas fa-hourglass-half mr-1"></i>4 Hours
                    </button>
                    <button type="button" onclick="setQuickTime('1d')" 
                      class="px-3 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 
                             text-white rounded-lg text-xs font-medium transition-all duration-200 
                             transform hover:scale-105 active:scale-95 shadow-lg">
                      <i class="fas fa-calendar-day mr-1"></i>1 Day
                    </button>
                  </div>
                  <div class="grid grid-cols-2 gap-2 mt-2">
                    <button type="button" onclick="setQuickTime('now')" 
                      class="px-3 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 
                             text-white rounded-lg text-xs font-medium transition-all duration-200 
                             transform hover:scale-105 active:scale-95 shadow-lg">
                      <i class="fas fa-bolt mr-1"></i>Start Now
                    </button>
                    <button type="button" onclick="setQuickTime('clear')" 
                      class="px-3 py-2 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600 
                             text-white rounded-lg text-xs font-medium transition-all duration-200 
                             transform hover:scale-105 active:scale-95 shadow-lg">
                      <i class="fas fa-eraser mr-1"></i>Clear
                    </button>
                  </div>
                </div>
              </div>
              <div id="tch-od-extra" class="hidden grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-white/70">OD Duration</label>
                  <select id="tch-od-duration" class="w-full p-2 rounded mt-1 bg-white/10 border border-white/20 text-white">
                    <option value="half_day">Half Day</option>
                    <option value="full_day">Full Day</option>
                    <option value="n_days">N Days</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs text-white/70">No. of days</label>
                  <input id="tch-od-days" type="number" min="1" class="w-full p-2 rounded mt-1 bg-white/10 border border-white/20 text-white" />
                </div>
              </div>
              <div id="tch-other-extra" class="hidden">
                <label class="text-xs text-white/70">Hours/Time</label>
                <input id="tch-other-hours" class="w-full p-2 rounded mt-1 bg-white/10 border border-white/20 text-white" placeholder="e.g. 3 hours" />
              </div>
              <div class="pt-2">
                <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded" onclick="submitTeacherOP('${rollno}')">Create</button>
                <span id="tch-op-msg" class="text-sm ml-3"></span>
              </div>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
      // toggle extra fields based on type
      const typeSel = document.getElementById('tch-op-type');
      const fromTo = document.getElementById('tch-op-fromto');
      const odExtra = document.getElementById('tch-od-extra');
      const otherExtra = document.getElementById('tch-other-extra');
      const updateExtras = () => {
        const t = typeSel.value;
        odExtra.classList.add('hidden');
        otherExtra.classList.add('hidden');
        fromTo.classList.remove('hidden');
        if (t === 'od_pass') { odExtra.classList.remove('hidden'); }
        if (t === 'other') { otherExtra.classList.remove('hidden'); }
      };
      typeSel.onchange = updateExtras; updateExtras();
      
      // Set default times (now and +10 minutes)
      const now = new Date();
      const later = new Date(now.getTime() + 10 * 60 * 1000); // +10 minutes
      document.getElementById('tch-op-from').value = formatDateTimeLocal(now);
      document.getElementById('tch-op-to').value = formatDateTimeLocal(later);
      
      // Add event listeners to update duration display
      const fromInput = document.getElementById('tch-op-from');
      const toInput = document.getElementById('tch-op-to');
      const updateDuration = () => {
        if (fromInput.value && toInput.value) {
          const from = new Date(fromInput.value);
          const to = new Date(toInput.value);
          const diff = to - from;
          
          if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const days = Math.floor(hours / 24);
            const remainingHours = hours % 24;
            
            let durationText = '';
            if (days > 0) {
              durationText = `${days}d ${remainingHours}h ${minutes}m`;
            } else if (hours > 0) {
              durationText = `${hours}h ${minutes}m`;
            } else {
              durationText = `${minutes}m`;
            }
            
            document.getElementById('duration-display').textContent = `Duration: ${durationText}`;
            document.getElementById('duration-display').className = 'text-xs text-green-300 font-semibold';
          } else {
            document.getElementById('duration-display').textContent = 'Invalid duration';
            document.getElementById('duration-display').className = 'text-xs text-red-300 font-semibold';
          }
        }
      };
      
      fromInput.addEventListener('change', updateDuration);
      toInput.addEventListener('change', updateDuration);
      updateDuration(); // Initial calculation
    }
    
    // Helper function to format date for datetime-local input
    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // Quick time setting buttons
    window.setQuickTime = function(option) {
      const fromInput = document.getElementById('tch-op-from');
      const toInput = document.getElementById('tch-op-to');
      const now = new Date();
      
      switch(option) {
        case 'now':
          fromInput.value = formatDateTimeLocal(now);
          const tenMinutesLater = new Date(now.getTime() + 10 * 60 * 1000);
          toInput.value = formatDateTimeLocal(tenMinutesLater);
          break;
        case '2h':
          if (fromInput.value) {
            const fromDate = new Date(fromInput.value);
            const toDate = new Date(fromDate.getTime() + 2 * 60 * 60 * 1000);
            toInput.value = formatDateTimeLocal(toDate);
          } else {
            fromInput.value = formatDateTimeLocal(now);
            const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            toInput.value = formatDateTimeLocal(twoHoursLater);
          }
          break;
        case '4h':
          if (fromInput.value) {
            const fromDate = new Date(fromInput.value);
            const toDate = new Date(fromDate.getTime() + 4 * 60 * 60 * 1000);
            toInput.value = formatDateTimeLocal(toDate);
          } else {
            fromInput.value = formatDateTimeLocal(now);
            const fourHoursLater = new Date(now.getTime() + 4 * 60 * 60 * 1000);
            toInput.value = formatDateTimeLocal(fourHoursLater);
          }
          break;
        case '1d':
          if (fromInput.value) {
            const fromDate = new Date(fromInput.value);
            const toDate = new Date(fromDate.getTime() + 24 * 60 * 60 * 1000);
            toInput.value = formatDateTimeLocal(toDate);
          } else {
            fromInput.value = formatDateTimeLocal(now);
            const oneDayLater = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            toInput.value = formatDateTimeLocal(oneDayLater);
          }
          break;
        case 'clear':
          fromInput.value = '';
          toInput.value = '';
          break;
      }
      
      // Trigger change event to update duration display
      fromInput.dispatchEvent(new Event('change'));
      toInput.dispatchEvent(new Event('change'));
    }

    window.submitTeacherOP = async function(rollno){
      const msg = document.getElementById('tch-op-msg');
      try{
        const payload = {
          rollno: rollno,
          pass_type: document.getElementById('tch-op-type').value,
          reason: document.getElementById('tch-op-reason').value,
          from_datetime: document.getElementById('tch-op-from').value,
          to_datetime: document.getElementById('tch-op-to').value,
          od_duration: document.getElementById('tch-od-duration')?.value || '',
          od_days: Number(document.getElementById('tch-od-days')?.value || 0),
          other_hours: document.getElementById('tch-other-hours')?.value || ''
        };
        const res = await fetch('/out_pass/teacher_create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data.success){ msg.textContent = 'Out pass created'; msg.className = 'text-green-300 text-sm'; setTimeout(()=>{ const r=document.getElementById('op-slide-root'); if(r) r.remove(); }, 800); }
        else { msg.textContent = data.message||'Failed'; msg.className = 'text-red-300 text-sm'; }
      }catch(e){ msg.textContent = 'Error'; msg.className = 'text-red-300 text-sm'; }
    }

    async function initTeacherPasses(){
      const tbody = document.getElementById('tch-passes-tbody');
      const err = document.getElementById('tch-passes-error');
      const refresh = async () => {
        if (tbody) tbody.innerHTML = '';
        if (err) err.classList.add('hidden');
        try {
          const res = await fetch('/out_pass/pending');
          const data = await res.json();
          const rows = (data && data.success && Array.isArray(data.passes)) ? data.passes : [];
          if (tbody) tbody.innerHTML = rows.map(p => `
            <tr class="border-b border-white/10" id="pass-row-${p.id}">
              <td class="px-3 py-2 text-sm text-on-dark">${p.requester_name||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.rollno||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.department||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.pass_type||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.from_datetime||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.to_datetime||''}</td>
              <td class="px-3 py-2 text-xs muted-on-dark">${(p.pass_type==='od_pass')? (p.od_duration||'') + (p.od_duration==='n_days'?` (${p.od_days||''}d)`: '') : (p.pass_type==='other'? (p.other_hours||'') : '')}</td>
              <td class="px-3 py-2 text-sm">
                <button class="px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded mr-2 text-xs transition-colors" onclick="showApprovalForm(${p.id}, '${p.from_datetime||''}', '${p.to_datetime||''}')">Approve</button>
                <button class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs transition-colors" onclick="teacherRejectPass(${p.id})">Reject</button>
              </td>
            </tr>
            <tr id="approval-form-${p.id}" class="hidden border-b border-white/10 bg-gradient-to-r from-green-900/20 to-blue-900/20">
              <td colspan="8" class="p-4">
                <div class="bg-white/5 rounded-lg p-4 border border-green-500/30">
                  <h4 class="text-sm font-semibold text-white mb-3 flex items-center">
                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                    Approve Out Pass - Adjust Times (Optional)
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="text-xs text-green-200 mb-1 flex items-center">
                        <i class="fas fa-calendar-day mr-1"></i> From Date & Time
                      </label>
                      <input type="datetime-local" id="approve-from-${p.id}" value="${p.from_datetime||''}" 
                        class="w-full p-2 rounded bg-white/10 border border-green-500/50 text-white text-sm focus:border-green-400 focus:ring-1 focus:ring-green-500" />
                    </div>
                    <div>
                      <label class="text-xs text-green-200 mb-1 flex items-center">
                        <i class="fas fa-calendar-check mr-1"></i> To Date & Time
                      </label>
                      <input type="datetime-local" id="approve-to-${p.id}" value="${p.to_datetime||''}" 
                        class="w-full p-2 rounded bg-white/10 border border-green-500/50 text-white text-sm focus:border-green-400 focus:ring-1 focus:ring-green-500" />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="text-xs text-green-200 mb-1 flex items-center">
                      <i class="fas fa-comment mr-1"></i> Remarks (Optional)
                    </label>
                    <input type="text" id="approve-remarks-${p.id}" placeholder="Add any remarks..." 
                      class="w-full p-2 rounded bg-white/10 border border-green-500/50 text-white text-sm focus:border-green-400 focus:ring-1 focus:ring-green-500" />
                  </div>
                  <div class="flex gap-2">
                    <button onclick="confirmApproval(${p.id})" 
                      class="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white rounded font-medium text-sm transition-all">
                      <i class="fas fa-check mr-1"></i> Confirm Approval
                    </button>
                    <button onclick="hideApprovalForm(${p.id})" 
                      class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded font-medium text-sm transition-all">
                      <i class="fas fa-times mr-1"></i> Cancel
                    </button>
                  </div>
                </div>
              </td>
            </tr>`).join('');
        } catch (e) {
          if (err) { err.textContent = 'Error loading passes'; err.classList.remove('hidden'); }
        }
      };
      const btn = document.getElementById('tch-refresh-passes');
      if (btn) btn.onclick = refresh;
      window._teacherRefreshPasses = refresh;
      refresh();
    }

    // Show inline approval form
    window.showApprovalForm = function(id, fromDateTime, toDateTime) {
      // Hide any other open forms
      document.querySelectorAll('[id^="approval-form-"]').forEach(form => {
        form.classList.add('hidden');
      });
      
      // Show this form
      const form = document.getElementById(`approval-form-${id}`);
      if (form) {
        form.classList.remove('hidden');
        
        // Scroll to the form smoothly
        form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }
    
    // Hide approval form
    window.hideApprovalForm = function(id) {
      const form = document.getElementById(`approval-form-${id}`);
      if (form) {
        form.classList.add('hidden');
      }
    }
    
    // Confirm approval with adjusted times
    window.confirmApproval = async function(id) {
      try {
        const fromInput = document.getElementById(`approve-from-${id}`);
        const toInput = document.getElementById(`approve-to-${id}`);
        const remarksInput = document.getElementById(`approve-remarks-${id}`);
        
        const payload = {
          decision: 'approved',
          remarks: remarksInput?.value || '',
          from_datetime: fromInput?.value || '',
          to_datetime: toInput?.value || ''
        };
        
        await fetch(`/out_pass/${id}/decision`, { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify(payload) 
        });
        
        // Hide form and refresh
        hideApprovalForm(id);
        if (window._teacherRefreshPasses) window._teacherRefreshPasses();
      } catch(e) {
        console.error('Error approving pass:', e);
      }
    }
    
    window.teacherRejectPass = async function(id){
      if (!confirm('Are you sure you want to reject this out pass request?')) return;
      try{
        await fetch(`/out_pass/${id}/decision`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ decision:'rejected' }) });
      }catch(e){}
      if (window._teacherRefreshPasses) window._teacherRefreshPasses();
    }

    // Check for expired passes and show on teacher dashboard
    async function checkExpiredPassesForTeacher() {
      try {
        const res = await fetch('/out_pass/expired');
        const data = await res.json();
        if (data.success && data.expired_passes && data.expired_passes.length > 0) {
          const alertDiv = document.getElementById('teacher-expired-alert');
          const detailsDiv = document.getElementById('teacher-expired-details');
          
          if (alertDiv && detailsDiv) {
            alertDiv.classList.remove('hidden');
            detailsDiv.innerHTML = data.expired_passes.slice(0, 5).map(p => {
              const returnStatus = p.returned_to_campus === 'yes' 
                ? '<span class="text-green-400 text-xs"><i class="fas fa-check-circle mr-1"></i>Returned to Campus</span>'
                : p.returned_to_campus === 'no'
                ? '<span class="text-yellow-400 text-xs"><i class="fas fa-exclamation-circle mr-1"></i>Not Yet Returned</span>'
                : '<span class="text-gray-400 text-xs"><i class="fas fa-question-circle mr-1"></i>Status Unknown</span>';
              
              return `
              <div class="bg-red-900/30 p-2 rounded">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <div class="font-semibold">${p.requester_name || 'Unknown'} (${p.rollno || 'N/A'})</div>
                    <div class="text-xs text-white/70">${p.pass_type || 'Out Pass'} - Expired: ${new Date(p.to_datetime).toLocaleString()}</div>
                  </div>
                  <div class="ml-2">${returnStatus}</div>
                </div>
              </div>
            `;
            }).join('');
            
            if (data.expired_passes.length > 5) {
              detailsDiv.innerHTML += `<div class="text-xs text-white/60 mt-2">+ ${data.expired_passes.length - 5} more expired passes</div>`;
            }
          }
          
          // Update badge
          updateTeacherExpiredBadge(data.count);
        }
      } catch (e) {
        console.error('Error checking expired passes:', e);
      }
    }

    // Update expired pass badge for teachers
    function updateTeacherExpiredBadge(count) {
      const badge = document.getElementById('expired-pass-badge');
      if (badge && !teacherPassBadgeViewed) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    // Leave Approvals Functions
    async function loadLeaveApprovals() {
      const tbody = document.getElementById('leave-approvals-tbody');
      const refreshBtn = document.getElementById('refresh-leave-approvals');
      
      const fetchLeaveRequests = async () => {
        try {
          const res = await fetch('/leave_request/pending');
          const data = await res.json();
          
          if (data.success && data.leave_requests && data.leave_requests.length > 0) {
            tbody.innerHTML = data.leave_requests.map(req => `
              <tr class="border-b border-white/5 hover:bg-white/5">
                <td class="px-4 py-3 text-sm text-on-dark">${req.student_name || '-'}</td>
                <td class="px-4 py-3 text-sm text-on-dark">${req.rollno || '-'}</td>
                <td class="px-4 py-3 text-sm text-on-dark">${req.leave_type || '-'}</td>
                <td class="px-4 py-3 text-sm text-on-dark">${req.from_date || '-'}</td>
                <td class="px-4 py-3 text-sm text-on-dark">${req.to_date || '-'}</td>
                <td class="px-4 py-3 text-sm text-on-dark max-w-xs truncate" title="${req.reason || '-'}">${req.reason || '-'}</td>
                <td class="px-4 py-3 text-sm">
                  <div class="flex gap-2">
                    <button onclick="approveLeaveRequest(${req.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs transition-all">
                      <i class="fas fa-check mr-1"></i>Approve
                    </button>
                    <button onclick="rejectLeaveRequest(${req.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs transition-all">
                      <i class="fas fa-times mr-1"></i>Reject
                    </button>
                  </div>
                </td>
              </tr>
            `).join('');
            
            // Update badge
            const badge = document.getElementById('leave-pending-badge');
            if (badge && !teacherLeaveBadgeViewed) {
              badge.textContent = data.leave_requests.length;
              badge.classList.remove('hidden');
            }
          } else {
            tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-white/60">No pending leave requests</td></tr>';
            const badge = document.getElementById('leave-pending-badge');
            if (badge) badge.classList.add('hidden');
          }
        } catch (e) {
          console.error('Error loading leave requests:', e);
          tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-400">Error loading leave requests</td></tr>';
        }
      };
      
      await fetchLeaveRequests();
      
      if (refreshBtn) {
        refreshBtn.onclick = fetchLeaveRequests;
      }
    }
    
    window.approveLeaveRequest = async function(leaveId) {
      const remarks = prompt('Enter remarks (optional):');
      if (remarks === null) return; // User cancelled
      
      try {
        const res = await fetch(`/leave_request/${leaveId}/decision`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ decision: 'approved', remarks: remarks || '' })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('✅ Leave request approved! Student will be notified.');
          loadLeaveApprovals();
        } else {
          alert('❌ Error: ' + (data.message || 'Failed to approve leave request'));
        }
      } catch (e) {
        console.error('Error approving leave request:', e);
        alert('❌ Error approving leave request. Please try again.');
      }
    };
    
    window.rejectLeaveRequest = async function(leaveId) {
      const remarks = prompt('Enter reason for rejection:');
      if (!remarks) {
        alert('Please provide a reason for rejection.');
        return;
      }
      
      try {
        const res = await fetch(`/leave_request/${leaveId}/decision`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ decision: 'rejected', remarks: remarks })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('❌ Leave request rejected. Student will be notified.');
          loadLeaveApprovals();
        } else {
          alert('❌ Error: ' + (data.message || 'Failed to reject leave request'));
        }
      } catch (e) {
        console.error('Error rejecting leave request:', e);
        alert('❌ Error rejecting leave request. Please try again.');
      }
    };

    function initSearch() {
      const searchInput = document.getElementById('search-bar');
      const body = document.getElementById('search-results');
      if (!searchInput || !body) return;
      searchInput.addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        const filtered = allStudents.filter(s => s.name?.toLowerCase().includes(q) || s.rollno?.toLowerCase().includes(q));
        body.innerHTML = filtered.map(s => `
            <tr class="cursor-pointer hover:bg-white/5" onclick="openStudentDetails(${s.id})">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-on-dark">${s.name}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm muted-on-dark">${s.rollno}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm"><button class="text-blue-400 hover:underline">Details</button></td>
            </tr>
          `).join('') || `<tr><td colspan="3" class="px-6 py-4 text-center muted-on-dark">No students found</td></tr>`;
      });
    }

    window.openStudentDetails = function(id) {
      const student = allStudents.find(s => s.id == id);
      if (!student) return;
      const fields = [
        ["reg_no","Reg No"],["rollno","Roll No"],["name","Name"],["dob","DOB"],["gender","Gender"],["aadhar","Aadhar"],
        ["student_mobile","Student Mobile"],["blood_group","Blood Group"],["parent_name","Parent Name"],["parent_mobile","Parent Mobile"],
        ["address","Address"],["nationality","Nationality"],["religion","Religion"],["community","Community"],["caste","Caste"],
        ["day_scholar_or_hosteller","Day Scholar/Hosteller"],["current_semester","Class/Semester"],["seat_type","Seat Type"],
        ["quota_type","Quota Type"],["email","Email"],["pmss","PMSS"],["remarks","Remarks"],["bus_no","Bus No"],
        ["outside_staying_address","Outstaying Address"],["hosteller_room_no","Room No"],["owner_ph_no","Owner's Phone"]
      ];
      document.getElementById('student-details').innerHTML = fields.map(([key, label]) => 
        `<p><strong class="font-semibold text-gray-300">${label}:</strong> ${student[key] || '-'}</p>`
      ).join('');
      studentModal.classList.remove('hidden');
    }

    async function changePassword() {
      const newPass = document.getElementById('new-password').value.trim();
      const msg = document.getElementById('password-message');
      if (!newPass) {
        msg.textContent = "Password cannot be empty.";
        msg.className = "text-red-400 text-sm mt-2";
        return;
      }
      try {
        const res = await fetch('/reset_teacher_password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: newPass })
        });
        const result = await res.json();
        msg.textContent = result.message;
        msg.className = result.success ? "text-green-400 text-sm mt-2" : "text-red-400 text-sm mt-2";
        if (result.success) document.getElementById('new-password').value = '';
      } catch (err) {
        msg.textContent = "Error changing password.";
        msg.className = "text-red-400 text-sm mt-2";
      }
    }

    // Initial Load
    loadStudents().then(() => {
        handleNavigation('dashboard');
    });
});
</script>
</body>
</html>
