<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HOD Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .text-on-dark { color: #e5e7eb; }
    .muted-on-dark { color: #9ca3af; }
    .glass-dark { background: rgba(30, 30, 46, 0.5); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .neon-border { border-radius: 0.75rem; box-shadow: 0 0 5px rgba(236, 72, 153, 0.3), 0 0 10px rgba(236, 72, 153, 0.2); }
    .table-glass { background: rgba(30, 30, 46, 0.5); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .table-glass th { background: rgba(255, 255, 255, 0.05); }
    .table-glass tr:hover { background: rgba(255, 255, 255, 0.05); }
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 25; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
    .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
    .sidebar-glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); }
    .sidebar-button { display: flex; align-items: center; width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; transition: background-color 0.2s, color 0.2s; }
    .sidebar-button:hover { background-color: rgba(255, 255, 255, 0.1); color: #ffffff; }
    .sidebar-button i { width: 1.25rem; margin-right: 0.75rem; text-align: center; }
    .scrollbar-thin { scrollbar-width: thin; scrollbar-color: rgba(156, 163, 175, 0.5) rgba(229, 231, 235, 0.2); }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: rgba(229, 231, 235, 0.2); border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.7); }
    @media (max-width: 768px) { .sidebar-glass { width: 280px; transform: translateX(-100%); } .sidebar-glass.open { transform: translateX(0); } .main-content { padding: 1rem; } .glass-dark { margin: 0.5rem 0; } .grid { gap: 1rem; } .text-4xl { font-size: 2rem; } .text-2xl { font-size: 1.5rem; } .p-6 { padding: 1rem; } .px-6 { padding-left: 1rem; padding-right: 1rem; } .py-4 { padding-top: 0.75rem; padding-bottom: 0.75rem; } .table-glass { font-size: 0.875rem; } .table-glass th, .table-glass td { padding: 0.5rem; } #sidebar-toggle { display: block; } }
    @media (min-width: 769px) { #sidebar-toggle { display: none; } .sidebar-glass { transform: translateX(0); } }
  </style>
</head>
<body class="bg-[#2a104f] min-h-screen relative overflow-hidden">
  <div id="vanta-bg" class="fixed top-0 left-0 w-full h-full z-0"></div>
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-20 left-10 w-20 h-20 bg-white bg-opacity-10 rounded-full blur-xl"></div>
    <div class="absolute top-40 right-20 w-32 h-32 bg-white bg-opacity-5 rounded-full blur-2xl"></div>
    <div class="absolute bottom-20 left-1/4 w-24 h-24 bg-white bg-opacity-15 rounded-full blur-lg"></div>
    <div class="absolute bottom-40 right-1/3 w-16 h-16 bg-white bg-opacity-20 rounded-full blur-md"></div>
  </div>
  <button id="sidebar-toggle" class="fixed top-4 left-4 z-50 md:hidden bg-pink-600 text-white p-2 rounded shadow"><i class="fas fa-bars"></i></button>
  <div class="flex h-screen relative z-10">
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <aside id="sidebar" class="sidebar-glass sidebar-parallax w-64 h-screen fixed left-0 top-0 transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 z-30 text-white">
      <div class="sidebar-header px-6 py-4 font-bold text-lg">
        <div class="flex items-center justify-between">
          <button id="sidebar-menu-toggle" class="p-2 rounded hover:bg-white/10" title="Toggle menu"><svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5h14v2H3V5zm0 4h14v2H3V9zm0 4h14v2H3v-2z" clip-rule="evenodd"/></svg></button>
          <span class="ml-4">HOD</span>
        </div>
      </div>
      <nav class="sidebar-content px-2">
        <button class="sidebar-button" data-page="dashboard"><i class="fas fa-home"></i><span class="label">Dashboard</span></button>
        <button class="sidebar-button" data-page="attendance"><i class="fas fa-chart-line"></i><span class="label">Attendance</span></button>
        <button class="sidebar-button" data-page="view"><i class="fas fa-users"></i><span class="label">Department Students</span></button>
        <button class="sidebar-button" data-page="courses"><i class="fas fa-book"></i><span class="label">Course List</span></button>
        <button class="sidebar-button" data-page="passes"><i class="fas fa-ticket"></i><span class="label">Out Pass Approvals</span></button>
        <button class="sidebar-button" data-page="scholarship"><i class="fas fa-award"></i><span class="label">Scholarship Students</span></button>
        <button class="sidebar-button" data-page="day-scholar"><i class="fas fa-bus"></i><span class="label">Day Scholar</span></button>
        <button class="sidebar-button" data-page="hostel"><i class="fas fa-hotel"></i><span class="label">Hostel</span></button>
        <button class="sidebar-button" data-page="outside"><i class="fas fa-house-damage"></i><span class="label">Outside Staying</span></button>
        <button class="sidebar-button mt-8 w-full flex items-center justify-start text-red-500" id="logout-btn"><i class="fas fa-sign-out-alt mr-2"></i><span class="label">Logout</span></button>
      </nav>
    </aside>
    <div id="main-wrapper" class="flex-1 flex flex-col overflow-hidden md:ml-10 transition-all duration-300">
      <main id="main-content" class="flex-1 p-6 overflow-y-auto"></main>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    VANTA.NET({ el: "#vanta-bg", mouseControls: true, touchControls: true, gyroControls: false, minHeight: 200.00, minWidth: 200.00, scale: 1.00, scaleMobile: 1.00, color: 0xec4899, backgroundColor: 0x2a104f, points: 10.00, maxDistance: 25.00, spacing: 18.00 });

    // Pass department and attendance data from Flask
    const hodDepartment = {{ department|tojson|safe }} || 'All';
    const todayAbsent = {{ today_absent|tojson|safe }} || [];
    const lowAttendance = {{ low_attendance|tojson|safe }} || [];
    const departmentStudents = {{ department_students|tojson|safe }} || [];
    const hostellers = {{ hostellers|tojson|safe }} || [];
    const dayScholars = {{ day_scholars|tojson|safe }} || [];
    const outstayingStudents = {{ outstaying_students|tojson|safe }} || [];
    const itCount = {{ it_count|tojson|safe }} || 0;
    const aimlCount = {{ aiml_count|tojson|safe }} || 0;
    
    let allStudents = departmentStudents;

    const dashboardContent = `
      <div class="space-y-6">
        <div class="glass-dark neon-border p-6">
          <h1 class="text-2xl font-bold text-white mb-2">${hodDepartment} Department - HOD Dashboard</h1>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
            <div class="bg-white/5 rounded p-3">
              <div class="text-3xl font-bold text-pink-400">${aimlCount}</div>
              <div class="text-sm text-gray-400">AI & ML Students</div>
            </div>
            <div class="bg-white/5 rounded p-3">
              <div class="text-3xl font-bold text-indigo-400">${itCount}</div>
              <div class="text-sm text-gray-400">IT Students</div>
            </div>
            <div class="bg-white/5 rounded p-3">
              <div class="text-3xl font-bold text-green-400">${hostellers.length}</div>
              <div class="text-sm text-gray-400">Hostellers</div>
            </div>
            <div class="bg-white/5 rounded p-3">
              <div class="text-3xl font-bold text-yellow-400">${dayScholars.length}</div>
              <div class="text-sm text-gray-400">Day Scholars</div>
            </div>
            <div class="bg-white/5 rounded p-3">
              <div class="text-3xl font-bold text-purple-400">${outstayingStudents.length}</div>
              <div class="text-sm text-gray-400">Outside Staying</div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass-dark neon-border p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-on-dark">Today's Absent Students</h2>
              <span id="absent-count" class="text-sm text-red-400 font-semibold">${todayAbsent.length} absent</span>
            </div>
            <div id="absent-list" class="space-y-2 text-on-dark max-h-80 overflow-y-auto scrollbar-thin">
              ${todayAbsent.length > 0 ? 
                todayAbsent.map(s => `
                  <div class="p-2 bg-white/5 rounded hover:bg-white/10 transition-colors">
                    <span class="font-medium">${s.rollno}</span> - 
                    <span class="text-gray-300">${s.name || 'Name not available'}</span>
                  </div>
                `).join('') : 
                '<div class="muted-on-dark">No absent students today</div>'
              }
            </div>
          </div>
          
          <div class="glass-dark neon-border p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-on-dark">Low Attendance Alert (&lt; 75%)</h2>
              <span id="low-count" class="text-sm text-yellow-400 font-semibold">${lowAttendance.length} students</span>
            </div>
            <div id="low-list" class="space-y-2 text-on-dark max-h-80 overflow-y-auto scrollbar-thin">
              ${lowAttendance.length > 0 ? 
                lowAttendance.map(s => `
                  <div class="p-3 bg-white/5 rounded hover:bg-white/10 transition-colors border-l-4 border-yellow-500">
                    <div class="flex justify-between items-center">
                      <div>
                        <span class="font-medium">${s.rollno}</span> - 
                        <span class="text-gray-300">${s.name || 'Name not available'}</span>
                      </div>
                      <span class="text-sm font-bold ${s.attendance < 50 ? 'text-red-500' : 'text-yellow-500'}">
                        ${s.attendance}%
                      </span>
                    </div>
                  </div>
                `).join('') : 
                '<div class="muted-on-dark">No students with low attendance</div>'
              }
            </div>
          </div>
        </div>
      </div>`;

    const attendanceContent = `
      <div class="container mx-auto">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-semibold text-on-dark">Department Attendance Overview</h2>
          <div class="flex items-center gap-2">
            <select id="dept-filter" class="p-2 rounded bg-white/10 border border-white/20 text-on-dark text-sm">
              <option value="">All Departments</option>
            </select>
            <div id="att-loading" class="text-sm muted-on-dark">Loading attendance...</div>
          </div>
        </div>
        <div id="att-error" class="text-sm text-red-500 mb-3 hidden"></div>
        <div class="glass-dark neon-border overflow-hidden">
          <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
            <table class="min-w-full table-glass" id="att-table">
              <thead>
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Reg No</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Roll No</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Present Days</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Total Days</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Attendance %</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody id="att-tbody"></tbody>
            </table>
          </div>
        </div>
        <div class="mt-2 text-xs muted-on-dark">Fetched from /hod/all_students_attendance_averages</div>
      </div>`;

    const deptStudentsContent = `
      <div class="container mx-auto">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold text-on-dark">Department Students</h2>
          <div class="flex items-center gap-2">
            <label class="text-sm text-on-dark">Department:</label>
            <select id="hod-dept-filter" class="p-2 rounded bg-white/10 border border-white/20 text-on-dark text-sm">
              <option value="">${"All"}</option>
            </select>
          </div>
        </div>
        <div class="glass-dark neon-border overflow-hidden">
          <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
            <table class="min-w-full table-glass">
              <thead class="sticky top-0 z-10"><tr id="hdr"></tr></thead>
              <tbody id="body"></tbody>
            </table>
          </div>
        </div>
      </div>`;


    const coursesContent = `
<div class="container mx-auto">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-semibold text-on-dark flex items-center">
      <i class="fas fa-book-open text-purple-400 mr-3"></i>
      Course List
    </h2>
    <div id="courses-loading" class="text-sm text-purple-300">
      <i class="fas fa-spinner fa-spin mr-2"></i>Loading courses...
    </div>
  </div>
  <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  <div id="courses-empty" class="glass-dark neon-border p-12 text-center hidden">
    <i class="fas fa-book text-6xl text-white/20 mb-4"></i>
    <p class="text-white/60 text-lg">No courses found.</p>
  </div>
</div>
`;
    const passesContent = `
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-on-dark">Out Pass Approvals (HOD)</h2>
        <button id="hod-refresh-passes" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">Refresh</button>
      </div>
      <div id="hod-passes-error" class="text-sm text-red-400 mb-2 hidden"></div>
      <div class="glass-dark neon-border overflow-hidden">
        <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
          <table class="min-w-full table-glass">
            <thead>
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Roll</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Dept</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">From</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">To</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Details</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="hod-passes-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>`;

    const filteredListContent = (title) => `
<div class="container mx-auto">
  <h2 class="text-2xl font-semibold text-on-dark mb-4">${title}</h2>
  <div class="glass-dark neon-border overflow-hidden">
    <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
      <table class="min-w-full table-glass">
        <thead class="sticky top-0 z-10"><tr id="flt-hdr"></tr></thead>
        <tbody id="flt-body"></tbody>
      </table>
    </div>
  </div>
</div>`;

    const scholarshipContent = `
<div class="container mx-auto">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-2xl font-semibold text-on-dark">Scholarship Students</h2>
  </div>
  <div class="flex flex-wrap gap-2 mb-4">
    <button class="px-3 py-1 text-xs rounded bg-pink-600 text-white" data-sch="pmss">PMSS</button>
    <button class="px-3 py-1 text-xs rounded bg-white/10 text-on-dark" data-sch="mbc_bc">MBC/BC</button>
    <button class="px-3 py-1 text-xs rounded bg-white/10 text-on-dark" data-sch="tps">TPS</button>
    <button class="px-3 py-1 text-xs rounded bg-white/10 text-on-dark" data-sch="seven_five">7.5</button>
    <button class="px-3 py-1 text-xs rounded bg-white/10 text-on-dark" data-sch="pps">PPS</button>
  </div>
  <div class="glass-dark neon-border overflow-hidden">
    <div class="overflow-x-auto max-h-[70vh] scrollbar-thin">
      <table class="min-w-full table-glass">
        <thead class="sticky top-0 z-10"><tr id="flt-hdr"></tr></thead>
        <tbody id="flt-body"></tbody>
      </table>
    </div>
  </div>
</div>`;

    function render(content){ document.getElementById('main-content').innerHTML = content; }

    async function loadStudents(){
      try {
        const res = await fetch('/students');
        const data = await res.json();
        allStudents = Array.isArray(data) ? data : [];
      } catch(e){ allStudents = []; }
    }

    async function loadAbsent(){
      const listEl = document.getElementById('absent-list'); const countEl = document.getElementById('absent-count');
      try{ const data = await fetch('/hod/daily_absent_students', { headers: { 'Accept':'application/json' } }).then(r=>r.json()); const list = data?.absent_students || [];
        if (countEl) countEl.textContent = `${list.length} absent today`;
        listEl.innerHTML = list.length? list.map(s=>`<div class="flex justify-between items-center p-2 bg-white/5 rounded"><div><span class="font-semibold">${s.name}</span><span class="text-xs muted-on-dark ml-2">(${s.rollno})</span></div><span class="text-xs ${s.status==='No record'?'text-yellow-400':'text-red-400'}">${s.status}</span></div>`).join('') : '<div class="text-green-400 font-semibold">All present</div>';
      }catch(e){ if(listEl) listEl.innerHTML = '<div class="text-red-400">Error</div>'; }
    }

    async function loadAttendance(){
      const loadingEl = document.getElementById('att-loading'); const errorEl = document.getElementById('att-error'); const tbodyEl = document.getElementById('att-tbody');
      if (tbodyEl) tbodyEl.innerHTML = ''; if (errorEl) errorEl.classList.add('hidden');
      try{
        const deptSel = document.getElementById('dept-filter');
        const dept = deptSel ? (deptSel.value || '') : '';
        const response = await fetch('/hod/all_students_attendance_averages');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log('Attendance data received:', data); // Debug log
        let students = data?.students||[];
        if (dept) students = students.filter(s => (s.current_semester||s.class||'') === dept);
        if (students.length === 0) {
          tbodyEl.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-400">No attendance data available</td></tr>';
        } else {
          tbodyEl.innerHTML = students.map(s=>{
            const pct=Number(s.attendance_average||0); let color='text-red-400', bg='bg-red-900/20', status='Poor';
            if(pct>=90){color='text-green-400';bg='bg-green-900/20';status='Excellent';}
            else if(pct>=75){color='text-blue-400';bg='bg-blue-900/20';status='Good';}
            else if(pct>=60){color='text-yellow-400';bg='bg-yellow-900/20';status='Fair';}
            return `<tr class="border-b border-white/10"><td class="px-6 py-4 text-sm text-on-dark">${s.reg_no||'-'}</td><td class="px-6 py-4 text-sm muted-on-dark">${s.name||'-'}</td><td class="px-6 py-4 text-sm muted-on-dark">${s.rollno||'-'}</td><td class="px-6 py-4 text-sm muted-on-dark">${s.present_days||0}</td><td class="px-6 py-4 text-sm muted-on-dark">${s.total_days||0}</td><td class="px-6 py-4 text-sm font-semibold ${color}">${pct.toFixed(2)}%</td><td class="px-6 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bg} ${color}">${status}</span></td></tr>`;
          }).join('');
        }
      }catch(e){ 
        console.error('Error loading attendance:', e);
        if (errorEl){ errorEl.textContent=`Error loading attendance: ${e.message}`; errorEl.classList.remove('hidden'); }
        if (tbodyEl) tbodyEl.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-400">Error loading attendance data</td></tr>';
      }
      finally{ if (loadingEl) loadingEl.classList.add('hidden'); }
    }

    async function loadLow(){
      const listEl = document.getElementById('low-list'); const countEl = document.getElementById('low-count');
      try{ const data = await fetch('/hod/all_students_attendance_averages').then(r=>r.json()); const arr = (data?.students||[]).filter(s=> Number((s.attendance_average||0)) < 75);
        if (countEl) countEl.textContent = `${arr.length} students`;
        listEl.innerHTML = arr.length? arr.slice(0,50).map(s=>`<div class=\"flex justify-between items-center p-2 bg-red-900/20 rounded\"><div><span class=\"font-semibold\">${s.name}</span><span class=\"text-xs muted-on-dark ml-2\">(${s.rollno})</span></div><span class=\"text-xs text-red-400\">${Number(s.attendance_average||0).toFixed(1)}%</span></div>`).join('') : '<div class="text-green-400 font-semibold">No one below 75%</div>';
      }catch(e){ if(listEl) listEl.innerHTML = '<div class="text-red-400">Error</div>'; }
    }

    function renderTable(){
  const cols = [ {key:'id',label:'ID'},{key:'reg_no',label:'Reg No'},{key:'rollno',label:'Roll No'},{key:'name',label:'Name'},{key:'current_semester',label:'Class/Sem'} ];
      const hdr = document.getElementById('hdr'); const body = document.getElementById('body'); if (!hdr||!body) return;
      hdr.innerHTML = cols.map(c=>`<th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">${c.label}</th>`).join('');
      body.innerHTML = allStudents.map(s=>`<tr class="border-b border-white/5 hover:bg-white/5">${cols.map(c=>{
        let val = s[c.key] || '';
        if (c.key === 'scholarship') val = s.scholarship || s.remarks || '';
        return `<td class=\"px-3 py-2 text-[12px] truncate align-top" title=\"${val}\">${val}</td>`;
      }).join('')}</tr>`).join('');
    }


    async function populateHodDeptSelect(){
      try{
        const sel = document.getElementById('hod-dept-filter');
        if (!sel) return;
        // HOD can only see their own department
        sel.innerHTML = `<option value="">${hodDepartment || 'Your Department'}</option>`;
        sel.disabled = true; // Disable the selector
      }catch(e){}
    }

    async function populateDeptSelect(selectId){
      try{
        const sel = document.getElementById(selectId);
        if (!sel) return;
        // HOD can only see their own department - no filter needed
        sel.innerHTML = `<option value="">${hodDepartment || 'Your Department'}</option>`;
        sel.disabled = true; // Disable the selector for HOD
      }catch(e){}
    }

    async function loadCourses(){
      const grid = document.getElementById('courses-grid');
      const loading = document.getElementById('courses-loading');
      const empty = document.getElementById('courses-empty');
      if (!grid) return;
      try{
        const res = await fetch('/courses');
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0){
          if (empty) empty.classList.remove('hidden');
          grid.innerHTML = '';
          return;
        }
        
        const getIcon = (courseName) => {
          const name = (courseName || '').toLowerCase();
          if (name.includes('python') || name.includes('programming')) return 'fa-code';
          if (name.includes('data') || name.includes('database')) return 'fa-database';
          if (name.includes('web') || name.includes('html')) return 'fa-globe';
          if (name.includes('machine') || name.includes('ai')) return 'fa-robot';
          if (name.includes('network')) return 'fa-network-wired';
          if (name.includes('security') || name.includes('cyber')) return 'fa-shield-alt';
          if (name.includes('cloud')) return 'fa-cloud';
          if (name.includes('mobile') || name.includes('android')) return 'fa-mobile-alt';
          return 'fa-book';
        };
        
        const gradients = [
          'from-purple-600 to-pink-600',
          'from-blue-600 to-cyan-600',
          'from-green-600 to-teal-600',
          'from-orange-600 to-red-600',
          'from-indigo-600 to-purple-600',
          'from-pink-600 to-rose-600'
        ];
        
        grid.innerHTML = data.map((c, index) => {
          const gradient = gradients[index % gradients.length];
          const icon = getIcon(c.course_name);
          return `
            <div class="glass-dark neon-border rounded-lg overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-2xl">
              <div class="bg-gradient-to-r ${gradient} p-4 relative overflow-hidden">
                <div class="absolute top-0 right-0 opacity-10">
                  <i class="fas ${icon} text-8xl"></i>
                </div>
                <div class="relative z-10">
                  <i class="fas ${icon} text-3xl text-white mb-2"></i>
                  <h3 class="text-lg font-bold text-white line-clamp-2">${c.course_name || c.course_code}</h3>
                </div>
              </div>
              <div class="p-4">
                <div class="flex items-center mb-3">
                  <i class="fas fa-hashtag text-purple-400 mr-2"></i>
                  <span class="text-sm text-white/70 font-mono">${c.course_code || 'N/A'}</span>
                </div>
                <a href="${c.drive_link}" target="_blank" rel="noopener"
                   class="block w-full bg-gradient-to-r ${gradient} hover:opacity-90 text-white text-center py-2 px-4 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                  <i class="fas fa-external-link-alt mr-2"></i>
                  Open Course Materials
                </a>
              </div>
            </div>
          `;
        }).join('');
      } catch (e){
        grid.innerHTML = `
          <div class="col-span-full glass-dark neon-border p-6 text-center">
            <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-3"></i>
            <p class="text-red-400">Error loading courses.</p>
          </div>
        `;
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function renderFiltered(list){
      const cols = [ {key:'reg_no',label:'Reg No'},{key:'name',label:'Name'},{key:'rollno',label:'Roll No'},{key:'pmss',label:'Scholarship (PMSS)'} ];
      const hdr = document.getElementById('flt-hdr'); const body = document.getElementById('flt-body'); if (!hdr||!body) return;
      hdr.innerHTML = cols.map(c=>`<th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">${c.label}</th>`).join('');
      body.innerHTML = list.map(s=>`<tr class="border-b border-white/5 hover:bg-white/5">${cols.map(c=>`<td class=\"px-3 py-2 text-[12px] truncate align-top\" title=\"${s[c.key]||''}\">${s[c.key]||''}</td>`).join('')}</tr>`).join('');
    }

    async function initHodPasses(){
      const tbody = document.getElementById('hod-passes-tbody');
      const err = document.getElementById('hod-passes-error');
      const refresh = async () => {
        if (tbody) tbody.innerHTML = '';
        if (err) err.classList.add('hidden');
        try {
          const res = await fetch('/out_pass/pending');
          const data = await res.json();
          const rows = (data && data.success && Array.isArray(data.passes)) ? data.passes : [];
          if (tbody) tbody.innerHTML = rows.map(p => `
            <tr class="border-b border-white/10">
              <td class="px-3 py-2 text-sm text-on-dark">${p.requester_name||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.rollno||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.department||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.pass_type||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.from_datetime||''}</td>
              <td class="px-3 py-2 text-sm muted-on-dark">${p.to_datetime||''}</td>
              <td class="px-3 py-2 text-xs muted-on-dark">${(p.pass_type==='od_pass')? (p.od_duration||'') + (p.od_duration==='n_days'?` (${p.od_days||''}d)`: '') : (p.pass_type==='other'? (p.other_hours||'') : '')}</td>
              <td class="px-3 py-2 text-sm">
                <button class="px-2 py-1 bg-green-600 text-white rounded mr-2 text-xs" onclick="hodApprovePass(${p.id})">Approve</button>
                <button class="px-2 py-1 bg-red-600 text-white rounded text-xs" onclick="hodRejectPass(${p.id})">Reject</button>
              </td>
            </tr>`).join('');
        } catch (e) {
          if (err) { err.textContent = 'Error loading passes'; err.classList.remove('hidden'); }
        }
      };
      const btn = document.getElementById('hod-refresh-passes');
      if (btn) btn.onclick = refresh;
      window._hodRefreshPasses = refresh;
      refresh();
    }
    window.hodApprovePass = async function(id){ try{ await fetch(`/out_pass/${id}/decision`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ decision:'approved' }) }); }catch(e){} if (window._hodRefreshPasses) window._hodRefreshPasses(); }
    window.hodRejectPass = async function(id){ try{ await fetch(`/out_pass/${id}/decision`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ decision:'rejected' }) }); }catch(e){} if (window._hodRefreshPasses) window._hodRefreshPasses(); }

    function navigate(page){
      switch(page){
        case 'attendance':
          render(attendanceContent);
          setTimeout(async ()=>{
            await populateDeptSelect('dept-filter');
            await loadAttendance();
            const sel=document.getElementById('dept-filter');
            if (sel){
              sel.onchange=async ()=>{
                const loadingEl = document.getElementById('att-loading');
                if (loadingEl) loadingEl.classList.remove('hidden');
                await loadAttendance();
                if (loadingEl) loadingEl.classList.add('hidden');
              };
            }
          }, 0);
          break;
        case 'view': render(deptStudentsContent); setTimeout(async ()=>{ await populateHodDeptSelect(); const sel=document.getElementById('hod-dept-filter'); if (sel){ // default load based on current dept - HOD restricted to own department
              sel.disabled = true; // Disable department selector for HOD
              const data = await fetch('/students').then(r=>r.json());
              allStudents = Array.isArray(data)? data: [];
            }
            renderTable();
          }, 0); break;
        case 'daily-absent': render(dashboardContent); setTimeout(()=>{ loadAbsent(); loadLow(); }, 0); break;
        case 'courses': render(coursesContent); setTimeout(loadCourses, 0); break;
        case 'passes': render(passesContent); setTimeout(initHodPasses, 0); break;
        case 'scholarship':
          render(scholarshipContent);
          setTimeout(async ()=>{
            await loadStudents('');
            const renderCategory = (cat)=>{
              const cols = [
                {key:'reg_no',label:'Reg No'},
                {key:'name',label:'Name'},
                {key:'rollno',label:'Roll No'},
                {key:'category',label:'Scholarship'}
              ];
              const list = (allStudents||[]).filter(s=>{
                const sch = String(s.scholarship||'').toLowerCase();
                const pmss = String(s.pmss||'').toLowerCase();
                const remarks = String(s.remarks||'').toLowerCase();
                if (cat==='pmss') return pmss === 'yes' || sch.includes('pmss') || remarks.includes('pmss');
                if (cat==='mbc_bc') return sch.includes('mbc') || sch.includes('bc') || remarks.includes('mbc') || remarks.includes('bc');
                if (cat==='tps') return sch.includes('tps') || remarks.includes('tps');
                if (cat==='seven_five') return sch.includes('7.5') || sch.includes('7,5') || remarks.includes('7.5');
                if (cat==='pps') return sch.includes('pps') || remarks.includes('pps');
                return false;
              }).map(({reg_no, name, rollno, scholarship, pmss})=>({
                reg_no, name, rollno,
                category: (cat==='pmss' ? 'PMSS' : (scholarship||'').toString()),
              }));
              renderFiltered(list, cols);
            };
            document.querySelectorAll('[data-sch]').forEach(b=>{
              b.addEventListener('click', (e)=>{
                document.querySelectorAll('[data-sch]').forEach(x=>{ x.classList.remove('bg-pink-600','text-white'); x.classList.add('bg-white/10','text-on-dark'); });
                e.currentTarget.classList.add('bg-pink-600','text-white');
                e.currentTarget.classList.remove('bg-white/10','text-on-dark');
                renderCategory(e.currentTarget.getAttribute('data-sch'));
              });
            });
            renderCategory('pmss');
          }, 0);
          break;
        case 'day-scholar':
          render(filteredListContent('Day Scholar Students'));
          setTimeout(async ()=>{
            await loadStudents(''); // Load all students for filtering
            const list = allStudents.filter(s => (s.day_scholar_or_hosteller||'').toLowerCase().includes('day'))
              .map(({reg_no, name, rollno, bus_no}) => ({reg_no, name, rollno, bus_no}));
            const cols = [
              {key:'reg_no',label:'Reg No'},
              {key:'name',label:'Name'},
              {key:'rollno',label:'Roll No'},
              {key:'bus_no',label:'Bus No'}
            ];
            renderFiltered(list, cols);
          }, 0);
          break;
        case 'hostel':
          render(filteredListContent('Hostel Students'));
          setTimeout(async ()=>{
            await loadStudents(''); // Load all students for filtering
            const list = allStudents.filter(s => (s.day_scholar_or_hosteller||'').toLowerCase().includes('hostel'))
              .map(({reg_no, name, rollno, hosteller_room_no}) => ({reg_no, name, rollno, hosteller_room_no}));
            const cols = [
              {key:'reg_no',label:'Reg No'},
              {key:'name',label:'Name'},
              {key:'rollno',label:'Roll No'},
              {key:'hosteller_room_no',label:'Room No'}
            ];
            renderFiltered(list, cols);
          }, 0);
          break;
        case 'outside':
          render(filteredListContent('Outside Staying Students'));
          setTimeout(async ()=>{
            await loadStudents(''); // Load all students for filtering
            const list = allStudents.filter(s =>
              s.outside_staying_address &&
              s.outside_staying_address.trim().toLowerCase() !== 'no' &&
              s.outside_staying_address.trim() !== ''
            ).map(({reg_no, name, rollno, outside_staying_address}) => ({reg_no, name, rollno, outside_staying_address}));
            const cols = [
              {key:'reg_no',label:'Reg No'},
              {key:'name',label:'Name'},
              {key:'rollno',label:'Roll No'},
              {key:'outside_staying_address',label:'Outside Staying Address'}
            ];
            renderFiltered(list, cols);
          }, 0);
          break;
        default: render(dashboardContent); setTimeout(()=>{ loadAbsent(); loadLow(); }, 0); break;
      }
    }

    async function loadCourses(){
      const ul = document.getElementById('courses-list');
      const loading = document.getElementById('courses-loading');
      const empty = document.getElementById('courses-empty');
      if (!ul) return;
      try{
        const res = await fetch('/courses');
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0){
          if (empty) empty.classList.remove('hidden');
          ul.innerHTML = '';
          return;
        }
        ul.innerHTML = data.map(c => `
          <li>
            <a href="${c.drive_link}" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 underline">${c.course_name || c.course_code}</a>
            <span class="text-sm muted-on-dark ml-2">${c.course_code || ''}</span>
          </li>
        `).join('');
      } catch (e){
        ul.innerHTML = '<li class="text-red-400">Error loading courses.</li>';
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    function renderFiltered(list, cols){
      const hdr = document.getElementById('flt-hdr'); const body = document.getElementById('flt-body'); if (!hdr||!body) return;
      hdr.innerHTML = cols.map(c=>`<th class="px-3 py-2 text-[11px] font-semibold uppercase tracking-wider text-on-dark/80 text-left whitespace-nowrap">${c.label}</th>`).join('');
      body.innerHTML = list.map(s=>`<tr class="border-b border-white/5 hover:bg-white/5">${cols.map(c=>`<td class="px-3 py-2 text-[12px] truncate align-top" title="${s[c.key]||''}\">${s[c.key]||''}</td>`).join('')}</tr>`).join('');
    }

    const sidebar=document.getElementById('sidebar'); const toggleBtn=document.getElementById('sidebar-toggle'); const overlay=document.getElementById('sidebar-overlay'); const menuToggle=document.getElementById('sidebar-menu-toggle');
    if (toggleBtn && sidebar){ toggleBtn.addEventListener('click',()=>{ sidebar.classList.toggle('open'); overlay.classList.toggle('active'); }); overlay.addEventListener('click',()=>{ sidebar.classList.remove('open'); overlay.classList.remove('active'); }); window.addEventListener('resize',()=>{ if (window.innerWidth>=768){ sidebar.classList.remove('open'); overlay.classList.remove('active'); } }); }
    if (menuToggle && sidebar){ menuToggle.addEventListener('click',()=>{ const collapsed=sidebar.classList.contains('menu-collapsed'); if (collapsed){ sidebar.classList.remove('menu-collapsed'); } else { sidebar.classList.add('menu-collapsed'); } }); }
    document.querySelectorAll('.sidebar-button[data-page]').forEach(btn=>{ btn.addEventListener('click', function(){ const page=this.getAttribute('data-page'); navigate(page); if (window.innerWidth<768){ sidebar.classList.add('-translate-x-full'); overlay.classList.remove('active'); } }); });
    document.getElementById('logout-btn').addEventListener('click',()=> window.location.href='/logout');

    loadStudents().then(()=>{ navigate('dashboard'); }).catch(()=>{ navigate('dashboard'); });
  });
  </script>
</body>
</html>
